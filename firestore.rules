rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========== 헬퍼 함수 ==========
    
    // 사용자가 인증되었는지 확인
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 학생인지 확인
    function isStudent() {
      return isAuthenticated() && 
             request.auth.token.email != null &&
             request.auth.token.email.matches('.*@student\\.local$');
    }
    
    // 교사인지 확인
    function isTeacher() {
      return isAuthenticated() && 
             request.auth.token.email != null &&
             (request.auth.token.email.matches('.*@teacher\\.local$') ||
              request.auth.token.email.matches('.*@teacher.local$'));
    }
    
    // 이메일에서 학번 추출
    function getStudentIdFromEmail() {
      return request.auth.token.email.split('@')[0];
    }
    
    // 이메일에서 교사 ID 추출
    function getTeacherIdFromEmail() {
      return request.auth.token.email.split('@')[0];
    }
    
    // 관리자인지 확인
    // 관리자는 admin@admin.local 형식의 이메일을 사용
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.email != null &&
             request.auth.token.email.matches('.*@admin\\.local$');
    }
    
    // ========== 컬렉션별 규칙 ==========
    
    // users 컬렉션: 학생 개인 정보 및 활동 데이터
    match /users/{studentId} {
      // 학생은 자신의 데이터만 읽기/쓰기 가능
      allow read, write: if isStudent() && 
        getStudentIdFromEmail() == studentId;
      
      // 교사는 모든 학생 데이터 읽기 가능 (간단 버전)
      // 주의: 실제 운영 시에는 클라이언트 측에서 반별로 필터링하는 것을 권장
      // get: 개별 문서 읽기, list: 컬렉션 전체 조회
      allow get: if isTeacher();
      allow list: if isTeacher();
      
      // activities 서브컬렉션
      match /activities/{activityId} {
        // 학생은 자신의 활동 데이터 읽기/쓰기 가능
        allow read, write: if isStudent() && 
          getStudentIdFromEmail() == studentId;
        
        // 교사는 모든 학생 활동 데이터 읽기 가능
        allow get: if isTeacher();
        allow list: if isTeacher();
      }
    }
    
    // classes 컬렉션: 반별 학생 그룹
    match /classes/{classId} {
      // 교사는 자신의 반 데이터 읽기/쓰기 가능
      allow read, write: if isTeacher() && 
        getTeacherIdFromEmail() == classId;
      
      // 임시: 모든 교사가 모든 반 데이터 읽기 가능 (디버깅용)
      // 주의: 실제 운영 시에는 위의 규칙만 사용하고 이 줄을 제거하세요
      // 서브컬렉션을 list하려면 부모 문서에 대한 get 권한도 필요
      allow get: if isTeacher();
      allow list: if isTeacher();
      
      // 학생은 자신의 반 정보를 생성할 수 있어야 함 (로그인 시)
      // 주의: 보안을 위해 클라이언트에서 올바른 classId를 전달하는지 확인 필요
      // 실제 운영 시에는 users 문서를 읽어서 검증하는 것이 좋지만,
      // 성능을 위해 일단 학생이면 쓰기 허용 (클라이언트에서 검증)
      allow write: if isStudent();
      
      // 학생은 자신의 반 정보 읽기 가능
      allow read: if isStudent();
      
      // students 서브컬렉션
      match /students/{studentId} {
        // 교사는 자신의 반 학생 목록 읽기 가능
        // 서브컬렉션 list는 부모 문서의 get 권한도 필요하므로 위에서 허용됨
        allow get: if isTeacher() && 
          getTeacherIdFromEmail() == classId;
        allow list: if isTeacher() && 
          getTeacherIdFromEmail() == classId;
        
        // 임시: 모든 교사가 모든 반 학생 목록 읽기 가능 (디버깅용)
        allow get: if isTeacher();
        allow list: if isTeacher();
        
        // 학생은 자신을 반에 추가/업데이트 가능
        // 트랜잭션에서 읽기 후 쓰기를 하므로 읽기 권한도 필요
        allow get: if isStudent() && 
          getStudentIdFromEmail() == studentId;
        allow write: if isStudent() && 
          getStudentIdFromEmail() == studentId;
        
        // 교사는 자신의 반 학생 추가/업데이트 가능
        allow write: if isTeacher() && 
          getTeacherIdFromEmail() == classId;
        
        // 임시: 모든 교사가 모든 반 학생 추가/업데이트 가능 (디버깅용)
        allow write: if isTeacher();
      }
    }
    
    // teachers 컬렉션: 교사 계정 정보
    match /teachers/{teacherId} {
      // 공개 읽기 허용 (로그인 전에 비밀번호 확인을 위해 필요)
      // 주의: 비밀번호가 평문으로 저장되어 있으므로 보안상 주의 필요
      allow read: if true;
      
      // 교사는 자신의 계정을 생성할 수 있음 (로그인 시 자동 생성)
      // teacherId는 {schoolCode}-{grade}-{classNum} 형식
      // 교사 이메일도 동일한 형식이므로, 인증 후에만 자신의 계정 생성 가능
      allow create: if isTeacher() && 
        getTeacherIdFromEmail() == teacherId;
      
      // 교사는 자신의 계정 정보 업데이트 가능 (lastLogin 등)
      allow update: if isTeacher() && 
        getTeacherIdFromEmail() == teacherId;
      
      // 삭제는 관리자만 가능
      allow delete: if false;
    }
    
    // messages 컬렉션: 채팅 메시지
    match /messages/class/{classId}/messages/{messageId} {
      // 교사는 자신의 반 메시지 읽기/쓰기 가능
      allow read, write: if isTeacher() && 
        getTeacherIdFromEmail() == classId;
      
      // 학생은 모든 반 메시지 읽기 가능 (간단 버전)
      // 주의: 실제 운영 시에는 클라이언트 측에서 자신의 반 메시지만 필터링
      allow read: if isStudent();
    }
    
    match /messages/private/{chatId}/messages/{messageId} {
      // 교사는 자신이 포함된 채팅방 메시지 읽기/쓰기 가능
      allow read, write: if isTeacher() && 
        chatId.matches(getTeacherIdFromEmail() + '-.*');
      
      // 학생은 자신이 포함된 채팅방 메시지 읽기/쓰기 가능
      allow read, write: if isStudent() && 
        chatId.matches('.*-' + getStudentIdFromEmail());
    }
    
    // schools 컬렉션: 학교 정보 (선택사항)
    // 학교 목록은 로그인 전에도 조회 가능해야 하므로 공개 읽기 허용
    match /schools/{schoolCode} {
      // 누구나 읽기 가능 (로그인 전 학생도 학교 목록을 볼 수 있어야 함)
      allow read: if true;
      
      // 쓰기는 관리자만 가능
      // 주의: 관리자는 admin@admin.local 형식의 Firebase Authentication 계정으로 로그인해야 함
      allow write: if isAdmin();
    }
  }
}

